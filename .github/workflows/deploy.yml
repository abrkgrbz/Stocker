name: Selective Deploy to Coolify

on:
  push:
    branches: [master]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: changes
        run: |
          # Get the base commit to compare against
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # First push or force push - compare with empty tree
            BASE_SHA=$(git rev-list --max-parents=0 HEAD | tail -1)
          else
            BASE_SHA="${{ github.event.before }}"
          fi

          echo "Comparing $BASE_SHA to ${{ github.sha }}"

          # Get changed files
          CHANGED=$(git diff --name-only "$BASE_SHA" "${{ github.sha }}" 2>/dev/null || git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          echo "Changed files:"
          echo "$CHANGED"

          # Check backend changes (src/ directory - .NET backend)
          if echo "$CHANGED" | grep -qE "^src/" 2>/dev/null; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "Backend changes detected"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
            echo "No backend changes"
          fi

          # Check frontend changes (stocker-nextjs/ directory)
          if echo "$CHANGED" | grep -qE "^stocker-nextjs/" 2>/dev/null; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "Frontend changes detected"
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "No frontend changes"
          fi

  deploy-backend:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Coolify Backend Deploy
        env:
          WEBHOOK_URL: ${{ secrets.COOLIFY_WEBHOOK_BACKEND }}
          COOLIFY_TOKEN: ${{ secrets.COOLIFY_TOKEN }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "❌ Error: COOLIFY_WEBHOOK_BACKEND secret is not set"
            exit 1
          fi

          response=$(curl -s -w "\n%{http_code}" -X POST "$WEBHOOK_URL" \
            -H "Authorization: Bearer $COOLIFY_TOKEN")
          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | head -n -1)
          echo "Response: $body"
          echo "HTTP Code: $http_code"
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "✅ Backend deploy triggered successfully"
          else
            echo "❌ Backend deploy failed"
            exit 1
          fi

  deploy-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Coolify Frontend Deploy
        env:
          WEBHOOK_URL: ${{ secrets.COOLIFY_WEBHOOK_FRONTEND }}
          COOLIFY_TOKEN: ${{ secrets.COOLIFY_TOKEN }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "❌ Error: COOLIFY_WEBHOOK_FRONTEND secret is not set"
            exit 1
          fi

          response=$(curl -s -w "\n%{http_code}" -X POST "$WEBHOOK_URL" \
            -H "Authorization: Bearer $COOLIFY_TOKEN")
          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | head -n -1)
          echo "Response: $body"
          echo "HTTP Code: $http_code"
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "✅ Frontend deploy triggered successfully"
          else
            echo "❌ Frontend deploy failed"
            exit 1
          fi

  skip-deploy:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'false' && needs.detect-changes.outputs.frontend == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: No deployment needed
        run: echo "ℹ️ No relevant changes detected, skipping deployment"
