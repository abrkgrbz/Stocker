<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentry Test - Direct HTML</title>
    <!-- Load Sentry SDK -->
    <script
        src="https://browser.sentry-cdn.com/7.119.2/bundle.min.js"
        crossorigin="anonymous"
        onload="initSentry()"
    ></script>
    <script>
        // Initialize Sentry after SDK loads
        function initSentry() {
            if (typeof Sentry === 'undefined') {
                console.error('Sentry SDK failed to load');
                return;
            }

            console.log('Initializing Sentry...');
            Sentry.init({
                dsn: 'https://a70b942af7e82a02c637a852f0782226@o4510349217431552.ingest.de.sentry.io/4510349218807888',
                tunnel: '/monitoring', // Use tunnel to bypass ad blockers
                debug: true,
                environment: 'production',
                integrations: [
                    Sentry.replayIntegration(),
                ],
                tracesSampleRate: 1.0,
                replaysSessionSampleRate: 0.1,
                replaysOnErrorSampleRate: 1.0,
                beforeSend(event, hint) {
                    console.log('Sentry Event:', event);
                    return event;
                }
            });
            console.log('Sentry initialized successfully');
        }

        // Fallback if onload doesn't trigger
        window.addEventListener('load', function() {
            if (typeof Sentry !== 'undefined' && !Sentry.getCurrentHub) {
                initSentry();
            }
        });
    </script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .error-btn { background: #ff4444; color: white; border-color: #cc0000; }
        .info-btn { background: #4444ff; color: white; border-color: #0000cc; }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            background: #f0f0f0;
        }
        .log {
            background: #333;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Sentry Integration Test (Direct HTML)</h1>

    <div class="status">
        <h3>Status Check:</h3>
        <div id="status-info">Checking...</div>
    </div>

    <h2>Test Buttons:</h2>

    <button class="error-btn" onclick="testSimpleError()">
        Test Simple Error
    </button>

    <button class="error-btn" onclick="testAsyncError()">
        Test Async Error
    </button>

    <button class="info-btn" onclick="testConsoleLog()">
        Test Console Log
    </button>

    <button class="info-btn" onclick="testFetch()">
        Test Fetch to Sentry
    </button>

    <button onclick="clearLog()">
        Clear Log
    </button>

    <h3>Debug Log:</h3>
    <div id="log" class="log"></div>

    <script>
        const log = (msg) => {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${msg}\n`;
            console.log(msg);
        };

        const clearLog = () => {
            document.getElementById('log').textContent = '';
        };

        // Check if Sentry is loaded
        window.addEventListener('load', () => {
            const statusDiv = document.getElementById('status-info');
            let statusHTML = '';

            // Check for Sentry
            if (typeof window.Sentry !== 'undefined') {
                statusHTML += '✅ Sentry object found in window<br>';
                log('Sentry object detected');

                // Try to get hub
                try {
                    const hub = window.Sentry.getCurrentHub();
                    if (hub) {
                        statusHTML += '✅ Sentry Hub is available<br>';
                        log('Sentry Hub available');

                        const client = hub.getClient();
                        if (client) {
                            statusHTML += '✅ Sentry Client is configured<br>';
                            const options = client.getOptions();
                            if (options.dsn) {
                                statusHTML += `✅ DSN configured: ${options.dsn.substring(0, 30)}...<br>`;
                                log(`DSN: ${options.dsn}`);
                            } else {
                                statusHTML += '❌ No DSN configured<br>';
                                log('No DSN found');
                            }
                        } else {
                            statusHTML += '❌ No Sentry Client<br>';
                        }
                    }
                } catch (e) {
                    statusHTML += `⚠️ Error checking Sentry: ${e.message}<br>`;
                    log(`Error: ${e.message}`);
                }
            } else {
                statusHTML += '❌ Sentry not found in window object<br>';
                log('Sentry not found');
            }

            // Check for ad blockers
            const testUrl = 'https://o4510349217431552.ingest.de.sentry.io/api/4510349218807888/envelope/';
            fetch(testUrl, { method: 'POST', body: '{}' })
                .then(() => {
                    statusHTML += '✅ Can reach Sentry endpoint<br>';
                    log('Sentry endpoint reachable');
                })
                .catch(() => {
                    statusHTML += '❌ Cannot reach Sentry endpoint (may be blocked)<br>';
                    log('Sentry endpoint blocked or unreachable');
                })
                .finally(() => {
                    statusDiv.innerHTML = statusHTML;
                });
        });

        function testSimpleError() {
            log('Testing simple error...');
            try {
                throw new Error('Test Error from HTML page - ' + new Date().toISOString());
            } catch (e) {
                log('Error thrown: ' + e.message);

                if (window.Sentry) {
                    window.Sentry.captureException(e);
                    log('Sent to Sentry.captureException()');
                } else {
                    log('Sentry not available to capture error');
                }

                // Also throw it to trigger global handler
                setTimeout(() => {
                    throw e;
                }, 100);
            }
        }

        function testAsyncError() {
            log('Testing async error...');
            setTimeout(() => {
                throw new Error('Async Error Test - ' + new Date().toISOString());
            }, 1000);
        }

        function testConsoleLog() {
            log('Testing console methods...');
            console.error('Test console.error for Sentry');
            console.warn('Test console.warn for Sentry');
            console.info('Test console.info for Sentry');

            if (window.Sentry) {
                window.Sentry.captureMessage('Manual test message', 'info');
                log('Sent manual message to Sentry');
            }
        }

        function testFetch() {
            log('Testing direct fetch to Sentry...');
            const dsn = 'https://a70b942af7e82a02c637a852f0782226@o4510349217431552.ingest.de.sentry.io/4510349218807888';
            const [protocol, rest] = dsn.split('://');
            const [key, hostAndProject] = rest.split('@');
            const [host, projectId] = hostAndProject.split('/');

            const url = `https://${host}/api/${projectId}/store/`;

            const payload = {
                exception: {
                    values: [{
                        type: 'Error',
                        value: 'Direct API Test - ' + new Date().toISOString()
                    }]
                },
                level: 'error',
                platform: 'javascript',
                timestamp: Date.now() / 1000,
                environment: 'production'
            };

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Sentry-Auth': `Sentry sentry_version=7, sentry_client=test/1.0, sentry_key=${key}`
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                log(`Direct fetch response: ${response.status} ${response.statusText}`);
                if (response.ok) {
                    log('✅ Successfully sent to Sentry directly!');
                } else {
                    log('❌ Failed to send to Sentry');
                }
            })
            .catch(error => {
                log(`Direct fetch error: ${error.message}`);
                log('This might indicate Sentry is being blocked');
            });
        }

        // Listen for errors globally
        window.addEventListener('error', (event) => {
            log(`Global error caught: ${event.message}`);
        });

        window.addEventListener('unhandledrejection', (event) => {
            log(`Unhandled promise rejection: ${event.reason}`);
        });
    </script>
</body>
</html>