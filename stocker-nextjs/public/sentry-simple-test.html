<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Sentry Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            padding: 12px 24px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            background: #007bff;
            color: white;
            border: none;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 20px 0;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <h1>Simple Sentry Test (Without SDK)</h1>

    <div class="status">
        <h3>Direct API Test</h3>
        <p>This test sends errors directly to Sentry API without using the SDK.</p>
        <p>It uses the /monitoring tunnel to bypass ad blockers.</p>
    </div>

    <button onclick="sendDirectToTunnel()">
        Send Error via Tunnel (/monitoring)
    </button>

    <button onclick="sendDirectToSentry()">
        Send Error Direct to Sentry (May be blocked)
    </button>

    <button onclick="testTunnelEndpoint()">
        Test Tunnel Endpoint
    </button>

    <button onclick="clearLog()">
        Clear Log
    </button>

    <h3>Debug Log:</h3>
    <div id="log" class="log">Ready to test...</div>

    <script>
        const DSN = 'https://a70b942af7e82a02c637a852f0782226@o4510349217431552.ingest.de.sentry.io/4510349218807888';

        function log(msg, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning';
            logDiv.innerHTML += `<span class="${typeClass}">[${timestamp}] ${msg}</span>\n`;
            console.log(msg);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = 'Log cleared...\n';
        }

        async function testTunnelEndpoint() {
            log('Testing tunnel endpoint...');
            try {
                const response = await fetch('/monitoring', {
                    method: 'GET',
                });
                const data = await response.json();
                log('Tunnel endpoint response: ' + JSON.stringify(data, null, 2), 'success');
            } catch (error) {
                log('Tunnel endpoint error: ' + error.message, 'error');
            }
        }

        async function sendDirectToTunnel() {
            log('Sending error through tunnel...');

            const eventId = generateEventId();
            const timestamp = Date.now() / 1000;

            // Create Sentry envelope format
            const envelope = {
                sent_at: new Date().toISOString(),
                sdk: {
                    name: 'test',
                    version: '1.0.0'
                },
                dsn: DSN
            };

            const item = {
                type: 'event',
                data: {
                    event_id: eventId,
                    timestamp: timestamp,
                    platform: 'javascript',
                    environment: 'production',
                    level: 'error',
                    exception: {
                        values: [{
                            type: 'Error',
                            value: 'Test Error via Tunnel - ' + new Date().toISOString(),
                            stacktrace: {
                                frames: [{
                                    filename: 'test-page.html',
                                    function: 'sendDirectToTunnel',
                                    lineno: 100,
                                    colno: 10
                                }]
                            }
                        }]
                    },
                    tags: {
                        test: 'true',
                        via: 'tunnel'
                    },
                    user: {
                        id: 'test-user-123'
                    },
                    breadcrumbs: [
                        {
                            timestamp: timestamp - 1,
                            message: 'User clicked test button',
                            level: 'info'
                        }
                    ]
                }
            };

            // Create the envelope format
            const envelopeStr = JSON.stringify(envelope) + '\n' +
                               JSON.stringify({type: item.type}) + '\n' +
                               JSON.stringify(item.data);

            try {
                const response = await fetch('/monitoring', {
                    method: 'POST',
                    body: envelopeStr,
                    headers: {
                        'Content-Type': 'text/plain;charset=UTF-8',
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    log('✅ Success! Event sent via tunnel. Event ID: ' + eventId, 'success');
                    log('Response: ' + JSON.stringify(result), 'success');
                } else {
                    log('❌ Failed! Status: ' + response.status, 'error');
                    const text = await response.text();
                    log('Response: ' + text, 'error');
                }
            } catch (error) {
                log('❌ Network error: ' + error.message, 'error');
                log('This usually means the tunnel is working but CORS is blocking the response', 'warning');
            }
        }

        async function sendDirectToSentry() {
            log('Sending error directly to Sentry (may be blocked by ad blocker)...');

            const [protocol, rest] = DSN.split('://');
            const [key, hostAndProject] = rest.split('@');
            const [host, projectId] = hostAndProject.split('/');

            const url = `https://${host}/api/${projectId}/store/`;
            const eventId = generateEventId();

            const payload = {
                event_id: eventId,
                timestamp: Date.now() / 1000,
                platform: 'javascript',
                level: 'error',
                exception: {
                    values: [{
                        type: 'Error',
                        value: 'Direct API Test - ' + new Date().toISOString()
                    }]
                },
                tags: {
                    test: 'true',
                    via: 'direct'
                }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Sentry-Auth': `Sentry sentry_version=7, sentry_client=test/1.0, sentry_key=${key}`
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    log('✅ Success! Event sent directly. Event ID: ' + eventId, 'success');
                } else {
                    log('❌ Failed! Status: ' + response.status, 'error');
                }
            } catch (error) {
                log('❌ Network error (probably blocked): ' + error.message, 'error');
                log('This is expected if you have an ad blocker', 'warning');
            }
        }

        function generateEventId() {
            return 'xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Test tunnel on page load
        window.addEventListener('load', () => {
            log('Page loaded. Ready to test Sentry integration.', 'success');
            log('Click "Test Tunnel Endpoint" first to verify the tunnel is working.');
        });
    </script>
</body>
</html>