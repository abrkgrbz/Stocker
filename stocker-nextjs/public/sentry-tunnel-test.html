<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentry Tunnel Test - Production</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .status {
            padding: 15px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 4px;
            margin: 20px 0;
        }
        button {
            padding: 12px 24px;
            margin: 10px 5px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            border: none;
            transition: all 0.3s;
        }
        .primary {
            background: #4CAF50;
            color: white;
        }
        .primary:hover {
            background: #45a049;
        }
        .secondary {
            background: #2196F3;
            color: white;
        }
        .secondary:hover {
            background: #0b7dda;
        }
        .danger {
            background: #f44336;
            color: white;
        }
        .danger:hover {
            background: #da190b;
        }
        .log {
            background: #263238;
            color: #B0BEC5;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .success { color: #4CAF50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        .warning { color: #FFC107; font-weight: bold; }
        .info { color: #2196F3; }
        .timestamp { color: #607D8B; font-size: 11px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è Sentry Tunnel Test</h1>
        <p>Bu sayfa Sentry'ye tunnel √ºzerinden event g√∂nderir ve ad blocker'larƒ± bypass eder.</p>

        <div class="status">
            <strong>Production Tunnel Endpoint:</strong> https://stoocker.app/monitoring<br>
            <strong>Sentry Project:</strong> stocker-nextjs<br>
            <strong>Test Method:</strong> Direct API call via tunnel
        </div>

        <h3>Test Butonlarƒ±:</h3>

        <button class="primary" onclick="testTunnelEndpoint()">
            üîç Test Tunnel Endpoint
        </button>

        <button class="secondary" onclick="sendErrorViaTunnel()">
            üì§ Send Error via Tunnel
        </button>

        <button class="danger" onclick="sendCriticalError()">
            üö® Send Critical Error
        </button>

        <button class="secondary" onclick="sendMultipleEvents()">
            üìä Send Multiple Events
        </button>

        <button onclick="clearLog()">
            üóëÔ∏è Clear Log
        </button>

        <h3>üìù Debug Log:</h3>
        <div id="log" class="log"><span class="info">Ready to test Sentry tunnel...</span></div>
    </div>

    <script>
        const DSN = 'https://a70b942af7e82a02c637a852f0782226@o4510349217431552.ingest.de.sentry.io/4510349218807888';
        let eventCounter = 0;

        function log(msg, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('tr-TR');
            const typeClass = type === 'error' ? 'error' :
                             type === 'success' ? 'success' :
                             type === 'warning' ? 'warning' : 'info';

            logDiv.innerHTML += `\n<span class="timestamp">[${timestamp}]</span> <span class="${typeClass}">${msg}</span>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, msg);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '<span class="info">Log cleared. Ready for new tests...</span>';
        }

        async function testTunnelEndpoint() {
            log('Testing tunnel endpoint...', 'info');
            try {
                const response = await fetch('/monitoring', {
                    method: 'GET',
                });

                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Tunnel endpoint is working!', 'success');
                    log('Response: ' + JSON.stringify(data, null, 2), 'info');
                } else {
                    log('‚ùå Tunnel endpoint returned error: ' + response.status, 'error');
                }
            } catch (error) {
                log('‚ùå Failed to reach tunnel endpoint: ' + error.message, 'error');
                log('This might be a CORS issue or the endpoint is not deployed', 'warning');
            }
        }

        async function sendErrorViaTunnel() {
            eventCounter++;
            const eventId = generateEventId();
            const timestamp = Date.now() / 1000;

            log(`Sending error #${eventCounter} via tunnel...`, 'info');

            // Create Sentry envelope
            const envelope = {
                sent_at: new Date().toISOString(),
                sdk: {
                    name: 'test.javascript',
                    version: '1.0.0'
                },
                dsn: DSN
            };

            const eventData = {
                event_id: eventId,
                timestamp: timestamp,
                platform: 'javascript',
                level: 'error',
                environment: 'production',
                exception: {
                    values: [{
                        type: 'TestError',
                        value: `Test Error #${eventCounter} sent via Tunnel at ${new Date().toLocaleString('tr-TR')}`,
                        stacktrace: {
                            frames: [{
                                filename: 'sentry-tunnel-test.html',
                                function: 'sendErrorViaTunnel',
                                lineno: 150,
                                colno: 20,
                                in_app: true
                            }]
                        }
                    }]
                },
                tags: {
                    test: 'true',
                    via: 'tunnel',
                    browser: navigator.userAgent.includes('Chrome') ? 'Chrome' :
                            navigator.userAgent.includes('Firefox') ? 'Firefox' :
                            navigator.userAgent.includes('Safari') ? 'Safari' : 'Other',
                    test_number: eventCounter.toString()
                },
                user: {
                    id: 'test-user-' + Math.floor(Math.random() * 1000),
                    username: 'test@stoocker.app'
                },
                breadcrumbs: [
                    {
                        timestamp: timestamp - 2,
                        message: 'Page loaded',
                        level: 'info'
                    },
                    {
                        timestamp: timestamp - 1,
                        message: 'User clicked test button',
                        level: 'info'
                    }
                ],
                extra: {
                    test_timestamp: new Date().toISOString(),
                    test_source: 'sentry-tunnel-test.html',
                    ad_blocker_bypass: true
                }
            };

            // Format as Sentry envelope
            const envelopeStr = JSON.stringify(envelope) + '\n' +
                               JSON.stringify({type: 'event'}) + '\n' +
                               JSON.stringify(eventData);

            try {
                const response = await fetch('/monitoring', {
                    method: 'POST',
                    body: envelopeStr,
                    headers: {
                        'Content-Type': 'text/plain;charset=UTF-8',
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Event #${eventCounter} sent successfully!`, 'success');
                    log(`Event ID: ${eventId}`, 'success');
                    log('Check your Sentry dashboard for this event', 'info');
                } else {
                    log(`‚ùå Failed to send event #${eventCounter}`, 'error');
                    log('Response status: ' + response.status, 'error');
                    const text = await response.text();
                    log('Response: ' + text, 'error');
                }
            } catch (error) {
                log(`‚ùå Network error for event #${eventCounter}: ` + error.message, 'error');
            }
        }

        async function sendCriticalError() {
            eventCounter++;
            const eventId = generateEventId();
            const timestamp = Date.now() / 1000;

            log(`Sending CRITICAL error #${eventCounter}...`, 'warning');

            const envelope = {
                sent_at: new Date().toISOString(),
                sdk: { name: 'test.javascript', version: '1.0.0' },
                dsn: DSN
            };

            const eventData = {
                event_id: eventId,
                timestamp: timestamp,
                platform: 'javascript',
                level: 'fatal',
                environment: 'production',
                exception: {
                    values: [{
                        type: 'CriticalError',
                        value: `üö® CRITICAL: System failure simulation #${eventCounter}`,
                        mechanism: {
                            type: 'generic',
                            handled: false
                        }
                    }]
                },
                tags: {
                    severity: 'critical',
                    requires_immediate_action: 'true'
                },
                fingerprint: ['critical-error-test']
            };

            const envelopeStr = JSON.stringify(envelope) + '\n' +
                               JSON.stringify({type: 'event'}) + '\n' +
                               JSON.stringify(eventData);

            try {
                const response = await fetch('/monitoring', {
                    method: 'POST',
                    body: envelopeStr,
                    headers: { 'Content-Type': 'text/plain;charset=UTF-8' }
                });

                if (response.ok) {
                    log(`üö® Critical error #${eventCounter} sent!`, 'success');
                    log(`Event ID: ${eventId}`, 'warning');
                } else {
                    log(`Failed to send critical error #${eventCounter}`, 'error');
                }
            } catch (error) {
                log('Network error: ' + error.message, 'error');
            }
        }

        async function sendMultipleEvents() {
            log('Sending 5 events in rapid succession...', 'info');

            for (let i = 0; i < 5; i++) {
                await sendErrorViaTunnel();
                await new Promise(resolve => setTimeout(resolve, 500)); // Wait 500ms between events
            }

            log('‚úÖ Batch sending complete!', 'success');
            log('Check Sentry dashboard for all 5 events', 'info');
        }

        function generateEventId() {
            return 'xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Test on page load
        window.addEventListener('load', () => {
            log('Page loaded. Tunnel endpoint ready for testing.', 'success');
            log('Ad blocker bypass method: Using /monitoring tunnel', 'info');

            // Check if we're on production
            if (window.location.hostname === 'stoocker.app' || window.location.hostname === 'www.stoocker.app') {
                log('‚úÖ Running on production (stoocker.app)', 'success');
            } else {
                log('‚ö†Ô∏è Not running on production. Tunnel may not work.', 'warning');
            }
        });
    </script>
</body>
</html>