version: '3.8'

# Grafana - Visualization and Dashboards
# Connects to Prometheus for metrics and Seq for logs

services:
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    environment:
      # Admin credentials
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}

      # Security settings
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_USERS_ALLOW_ORG_CREATE=false
      - GF_AUTH_ANONYMOUS_ENABLED=false

      # Server settings
      - GF_SERVER_ROOT_URL=https://grafana.stoocker.app
      - GF_SERVER_DOMAIN=grafana.stoocker.app

      # Feature toggles
      - GF_FEATURE_TOGGLES_ENABLE=publicDashboards

      # Plugins to install
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-piechart-panel

      # SMTP for alerts (configure if needed)
      # - GF_SMTP_ENABLED=true
      # - GF_SMTP_HOST=smtp.example.com:587
      # - GF_SMTP_USER=alerts@stoocker.app
      # - GF_SMTP_PASSWORD=${SMTP_PASSWORD}
      # - GF_SMTP_FROM_ADDRESS=alerts@stoocker.app

    volumes:
      - grafana_data:/var/lib/grafana
      - ./provisioning:/etc/grafana/provisioning:ro
    networks:
      - coolify
    labels:
      # Traefik configuration
      - "traefik.enable=true"
      - "traefik.docker.network=coolify"

      # HTTPS Router
      - "traefik.http.routers.grafana-secure.rule=Host(`grafana.stoocker.app`)"
      - "traefik.http.routers.grafana-secure.entrypoints=https"
      - "traefik.http.routers.grafana-secure.tls=true"
      - "traefik.http.routers.grafana-secure.tls.certresolver=cloudflare"
      - "traefik.http.routers.grafana-secure.tls.domains[0].main=stoocker.app"
      - "traefik.http.routers.grafana-secure.tls.domains[0].sans=*.stoocker.app"
      - "traefik.http.routers.grafana-secure.service=grafana"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

      # HTTP Router (redirect to HTTPS)
      - "traefik.http.routers.grafana.rule=Host(`grafana.stoocker.app`)"
      - "traefik.http.routers.grafana.entrypoints=http"
      - "traefik.http.routers.grafana.middlewares=grafana-redirect"
      - "traefik.http.middlewares.grafana-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.grafana-redirect.redirectscheme.permanent=true"

      # Coolify labels
      - "coolify.managed=true"
      - "coolify.type=application"
      - "coolify.name=grafana"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  grafana_data:
    driver: local

networks:
  coolify:
    external: true
