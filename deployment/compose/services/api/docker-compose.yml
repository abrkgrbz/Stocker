version: '3.8'

# Stocker API - Production Configuration for Coolify
# All environment variables are properly structured based on API configuration

services:
  api:
    build:
      context: .
      dockerfile: ./src/API/Stocker.API/Dockerfile
    container_name: stocker-api
    restart: unless-stopped
    environment:
      # ==================================
      # ASPNETCORE CONFIGURATION
      # ==================================
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5000
      - ASPNETCORE_SWAGGER_ENABLED=true
      
      # ==================================
      # DATABASE CONNECTIONS (PostgreSQL)
      # ==================================
      # Connection strings are managed by Azure Key Vault
      # Database host for internal Docker network
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=stocker_admin
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=stocker_admin
      # Password is managed by Azure Key Vault

      # These connection strings are auto-injected from Azure Key Vault
      - ConnectionStrings__MasterConnection
      - ConnectionStrings__TenantConnection
      - ConnectionStrings__DefaultConnection
      
      # ==================================
      # LOGGING (SEQ)
      # ==================================
      - Logging__Seq__ServerUrl=https://seq.stoocker.app
      - Logging__Seq__ApiKey=${SEQ_API_KEY}
      - Logging__Seq__MinimumLevel=Information
      
      # ==================================
      # JWT AUTHENTICATION
      # ==================================
      # JWT Secret is now managed by Azure Key Vault
      - JwtSettings__Issuer=Stocker
      - JwtSettings__Audience=Stocker
      - JwtSettings__AccessTokenExpirationMinutes=60
      - JwtSettings__RefreshTokenExpirationDays=7
      
      # ==================================
      # EMAIL SETTINGS
      # ==================================
      # SMTP Host, Port, Username, Password are now managed by Azure Key Vault
      # Only configuration settings remain in environment variables
      - EmailSettings__FromEmail=info@stoocker.app
      - EmailSettings__FromName=Stoocker
      - EmailSettings__EnableSsl=true
      - EmailSettings__UseStartTls=true
      - EmailSettings__EnableEmail=true
      - EmailSettings__BaseUrl=https://stoocker.app
      - EmailSettings__TemplatesPath=EmailTemplates
      
      # ==================================
      # STORAGE (MINIO)
      # ==================================
      - MinioStorage__Endpoint=minio:9000
      - MinioStorage__PublicEndpoint=https://s3.stoocker.app
      - MinioStorage__AccessKey=${MINIO_ROOT_USER}
      - MinioStorage__SecretKey=${MINIO_ROOT_PASSWORD}
      - MinioStorage__BucketName=stocker-documents
      - MinioStorage__UseSSL=false
      - MinioStorage__Region=us-east-1
      
      # ==================================
      # REDIS CACHE
      # ==================================
      - Redis__ConnectionString=redis:6379
      - Redis__Password=${REDIS_PASSWORD}
      - Redis__DefaultDatabase=0
      - Redis__ConnectTimeout=5000
      - Redis__SyncTimeout=5000

      # ==================================
      # RABBITMQ MESSAGE BROKER
      # ==================================
      # Using internal Docker network - RabbitMQ container name
      # RabbitMQ Password is now managed by Azure Key Vault
      - RabbitMQ__Enabled=true
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__VirtualHost=/
      - RabbitMQ__Username=admin
      # RabbitMQ Password is managed by Azure Key Vault
      - RabbitMQ__Port=5672
      - RabbitMQ__UseSsl=false
      - RabbitMQ__Heartbeat=60
      - RabbitMQ__RequestedConnectionTimeout=30000
      - RabbitMQ__PrefetchCount=32
      - RabbitMQ__RetryCount=3
      - RabbitMQ__RetryInterval=5

      # ==================================
      # HANGFIRE BACKGROUND JOBS (PostgreSQL)
      # ==================================
      - Hangfire__DashboardPath=/hangfire
      - Hangfire__ServerName=Stocker-Server
      - Hangfire__WorkerCount=4
      - Hangfire__Queues=critical,default,low
      - Hangfire__RetryAttempts=3
      - HANGFIRE_DB_NAME=stocker_hangfire
      # Hangfire connection string auto-injected from Azure Key Vault
      - ConnectionStrings__HangfireConnection
      
      # ==================================
      # PASSWORD POLICY
      # ==================================
      - PasswordPolicy__MinimumLength=8
      - PasswordPolicy__MaximumLength=128
      - PasswordPolicy__RequireUppercase=true
      - PasswordPolicy__RequireLowercase=true
      - PasswordPolicy__RequireDigit=true
      - PasswordPolicy__RequireNonAlphanumeric=true
      - PasswordPolicy__RequiredUniqueChars=4
      - PasswordPolicy__PreventCommonPasswords=true
      - PasswordPolicy__PreventUserInfoInPassword=true
      - PasswordPolicy__PasswordHistoryCount=5
      - PasswordPolicy__PasswordExpirationDays=90
      - PasswordPolicy__MaxFailedAccessAttempts=5
      - PasswordPolicy__LockoutDurationMinutes=15
      - PasswordPolicy__MinimumStrengthScore=3
      
      # ==================================
      # SECURITY HEADERS
      # ==================================
      - SecurityHeaders__AddXContentTypeOptions=true
      - SecurityHeaders__AddXFrameOptions=true
      - SecurityHeaders__XFrameOptionsValue=DENY
      - SecurityHeaders__AddXXssProtection=true
      - SecurityHeaders__AddReferrerPolicy=true
      - SecurityHeaders__ReferrerPolicyValue=strict-origin-when-cross-origin
      - SecurityHeaders__AddContentSecurityPolicy=true
      - SecurityHeaders__AddStrictTransportSecurity=true
      - SecurityHeaders__HstsMaxAge=31536000
      - SecurityHeaders__HstsIncludeSubDomains=true
      - SecurityHeaders__HstsPreload=false
      
      # ==================================
      # RATE LIMITING
      # ==================================
      - TenantRateLimiting__Algorithm=SlidingWindow
      - TenantRateLimiting__PermitLimit=1000
      - TenantRateLimiting__WindowSeconds=60
      - TenantRateLimiting__QueueLimit=5
      - TenantRateLimiting__SegmentsPerWindow=4
      - TenantRateLimiting__TokensPerPeriod=10
      - TenantRateLimiting__ReplenishmentPeriodSeconds=1
            
      # ==================================
      # AZURE KEY VAULT INTEGRATION
      # ==================================
      - AZURE_KEY_VAULT_URI=${AZURE_KEY_VAULT_URI}
      - AZURE_TENANT_ID=${AZURE_TENANT_ID}
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
      - AZURE_CLIENT_SECRET=${AZURE_CLIENT_SECRET}

    networks:
      - coolify
    labels:
      # Traefik configuration for api.stoocker.app
      - "traefik.enable=true"
      - "traefik.docker.network=coolify"
      
      # API routing - HTTPS
      - "traefik.http.routers.api-secure.rule=Host(`api.stoocker.app`)"
      - "traefik.http.routers.api-secure.entrypoints=https"
      - "traefik.http.routers.api-secure.tls=true"
      - "traefik.http.routers.api-secure.tls.certresolver=cloudflare"
      - "traefik.http.routers.api-secure.tls.domains[0].main=stoocker.app"
      - "traefik.http.routers.api-secure.tls.domains[0].sans=*.stoocker.app"
      - "traefik.http.routers.api-secure.service=api"
      - "traefik.http.routers.api-secure.priority=100"
      - "traefik.http.services.api.loadbalancer.server.port=5000"
      
      # API routing - HTTP (redirect to HTTPS)
      - "traefik.http.routers.api.rule=Host(`api.stoocker.app`)"
      - "traefik.http.routers.api.entrypoints=http"
      - "traefik.http.routers.api.priority=100"
      - "traefik.http.routers.api.middlewares=redirect-to-https"
      
      # Middlewares
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
      
      
      # Coolify labels
      - "coolify.managed=true"
      - "coolify.type=application"
      - "coolify.name=stocker-api"
      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  coolify:
    external: true
    # Force rebuild - 14 Eki 2025 Sal 16:05:47
