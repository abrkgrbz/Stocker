var n=(n,e,a)=>new Promise((i,t)=>{var r=n=>{try{s(a.next(n))}catch(e){t(e)}},l=n=>{try{s(a.throw(n))}catch(e){t(e)}},s=n=>n.done?i(n.value):Promise.resolve(n.value).then(r,l);s((a=a.apply(n,e)).next())});import{aD as e,j as a,a5 as i,O as t,N as r,bd as l,au as s,S as o,c as d,ao as c,F as g,b1 as u,a0 as h,$ as m,aV as x,Y as y,B as p,T as j,bG as v}from"./chunk-BxJbIkJM.js";import{r as k}from"./chunk-nBmrMGrr.js";import{a as f}from"./chunk-Csfs_AE2.js";import"./chunk-BsETiAjl.js";const M=()=>{var M,T,w,b;const[C,S]=k.useState(!1),[B,I]=k.useState(null),[N,U]=k.useState([]),[z,P]=k.useState(null),[D,H]=k.useState(!1);k.useEffect(()=>{K()},[]);const K=()=>n(null,null,function*(){S(!0);try{const n=yield f.get("/api/master/migrations/pending");U(n.data.data||[])}catch(n){e.error("Migration durumu alınamadı")}finally{S(!1)}}),Y=[{title:"Tenant",key:"tenant",render:n=>a.jsxs("div",{children:[a.jsx("div",{style:{fontWeight:500},children:n.tenantName}),a.jsx("div",{style:{fontSize:12,color:"#666"},children:n.tenantCode})]})},{title:"Durum",key:"status",render:n=>n.error?a.jsx(y,{color:"error",children:"Hata"}):n.hasPendingMigrations?a.jsx(p,{count:n.pendingMigrations.length,children:a.jsx(y,{color:"warning",children:"Bekleyen Migration Var"})}):a.jsx(y,{color:"success",children:"Güncel"})},{title:"Bekleyen Migrationlar",key:"pending",render:n=>n.error?a.jsx(j,{title:n.error,children:a.jsx("span",{style:{color:"#ff4d4f"},children:"Bağlantı hatası"})}):n.hasPendingMigrations?a.jsx("div",{children:n.pendingMigrations.map((n,e)=>a.jsxs("div",{style:{fontSize:12},children:["• ",n]},e))}):a.jsx("span",{style:{color:"#52c41a"},children:"Yok"})},{title:"Uygulanan",key:"applied",render:n=>{var e;return a.jsxs("span",{children:[(null==(e=n.appliedMigrations)?void 0:e.length)||0," migration"]})}},{title:"İşlemler",key:"actions",width:200,render:i=>a.jsxs(o,{children:[a.jsx(j,{title:"Migration geçmişini görüntüle",children:a.jsx(d,{type:"link",icon:a.jsx(v,{}),onClick:()=>{return e=i,n(null,null,function*(){P(e),H(!0)});var e}})}),i.hasPendingMigrations&&!i.error&&a.jsx(d,{type:"primary",size:"small",icon:a.jsx(c,{}),loading:B===i.tenantId,onClick:()=>{return r=i.tenantId,l=i.tenantName,n(null,null,function*(){u.confirm({title:"Migration Uygula",content:a.jsxs("div",{children:[a.jsxs("p",{children:[a.jsx("strong",{children:l})," tenant'ına migration'lar uygulanacak."]}),a.jsx(t,{message:"Dikkat",description:"Bu işlem database şemasını değiştirecektir. İşlem geri alınamaz!",type:"warning",showIcon:!0,style:{marginTop:12}})]}),okText:"Uygula",cancelText:"İptal",okType:"danger",onOk:()=>n(null,null,function*(){var n,a;I(r);try{const n=yield f.post(`/api/master/migrations/apply/${r}`);e.success(n.data.message||"Migration başarıyla uygulandı"),yield K()}catch(i){e.error((null==(a=null==(n=i.response)?void 0:n.data)?void 0:a.message)||"Migration uygulanamadı")}finally{I(null)}})})});var r,l},children:"Migration Uygula"})]})}],$=N.filter(n=>n.hasPendingMigrations&&!n.error);return a.jsxs("div",{className:"migrations-page",children:[a.jsxs(i,{title:a.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[a.jsxs("span",{children:[a.jsx(s,{})," Database Migration Yönetimi"]}),a.jsxs(o,{children:[a.jsx(d,{icon:a.jsx(c,{}),onClick:K,loading:C,children:"Yenile"}),$.length>0&&a.jsxs(d,{type:"primary",danger:!0,icon:a.jsx(g,{}),onClick:()=>n(null,null,function*(){u.confirm({title:"Tüm Tenantlara Migration Uygula",content:a.jsxs("div",{children:[a.jsx("p",{children:"Tüm aktif tenant'lara bekleyen migration'lar uygulanacak."}),a.jsx(t,{message:"Kritik İşlem",description:"Bu işlem TÜM tenant database'lerini güncelleyecektir. İşlem geri alınamaz ve uzun sürebilir!",type:"error",showIcon:!0,style:{marginTop:12}})]}),okText:"Tümüne Uygula",cancelText:"İptal",okType:"danger",onOk:()=>n(null,null,function*(){var n,i;const r=e.loading("Migrationlar uygulanıyor...",0);S(!0);try{const n=yield f.post("/api/master/migrations/apply-all");r(),u.info({title:"Migration Sonuçları",width:800,content:a.jsxs("div",{children:[a.jsx("p",{children:n.data.message}),a.jsx(h,{}),a.jsx("div",{style:{maxHeight:400,overflow:"auto"},children:n.data.results.map(n=>a.jsxs("div",{style:{marginBottom:12},children:[a.jsx(y,{color:n.success?"success":"error",children:n.success?a.jsx(m,{}):a.jsx(x,{})}),a.jsxs("strong",{children:[n.tenantName,":"]})," ",n.message,n.error&&a.jsx(t,{message:n.error,type:"error",style:{marginTop:4}})]},n.tenantId))})]}),okText:"Tamam"}),yield K()}catch(l){r(),e.error((null==(i=null==(n=l.response)?void 0:n.data)?void 0:i.message)||"Migrationlar uygulanamadı")}finally{S(!1)}})})}),loading:C,children:["Tümüne Uygula (",$.length," tenant)"]})]})]}),children:[$.length>0&&a.jsx(t,{message:`${$.length} tenant'ta bekleyen migration var`,description:"Migration'ları tek tek veya toplu olarak uygulayabilirsiniz.",type:"warning",showIcon:!0,style:{marginBottom:16}}),a.jsx(r,{spinning:C,children:a.jsx(l,{dataSource:N,columns:Y,rowKey:"tenantId",pagination:!1,rowClassName:n=>n.error?"error-row":""})})]}),a.jsx(u,{title:`Migration Geçmişi - ${null==z?void 0:z.tenantName}`,open:D,onCancel:()=>H(!1),footer:[a.jsx(d,{onClick:()=>H(!1),children:"Kapat"},"close")],width:600,children:z&&a.jsxs("div",{children:[a.jsxs("p",{children:[a.jsx("strong",{children:"Tenant Kodu:"})," ",z.tenantCode]}),a.jsx(h,{}),a.jsxs("h4",{children:["Uygulanan Migration'lar (",(null==(M=z.appliedMigrations)?void 0:M.length)||0,")"]}),a.jsx("div",{style:{maxHeight:300,overflow:"auto"},children:(null==(T=z.appliedMigrations)?void 0:T.map((n,e)=>a.jsxs("div",{style:{padding:"4px 0"},children:[a.jsx(m,{style:{color:"#52c41a",marginRight:8}}),n]},e)))||a.jsx("p",{children:"Migration geçmişi yok"})}),z.hasPendingMigrations&&a.jsxs(a.Fragment,{children:[a.jsx(h,{}),a.jsxs("h4",{style:{color:"#faad14"},children:["Bekleyen Migration'lar (",(null==(w=z.pendingMigrations)?void 0:w.length)||0,")"]}),a.jsx("div",{style:{maxHeight:200,overflow:"auto"},children:null==(b=z.pendingMigrations)?void 0:b.map((n,e)=>a.jsxs("div",{style:{padding:"4px 0"},children:[a.jsx(x,{style:{color:"#faad14",marginRight:8}}),n]},e))})]})]})})]})};export{M as default};
