var n=(n,i,e)=>new Promise((a,t)=>{var r=n=>{try{s(e.next(n))}catch(i){t(i)}},l=n=>{try{s(e.throw(n))}catch(i){t(i)}},s=n=>n.done?a(n.value):Promise.resolve(n.value).then(r,l);s((e=e.apply(n,i)).next())});import{aD as i,j as e,a5 as a,O as t,N as r,bd as l,au as s,S as o,c as d,ao as g,F as c,b1 as u,a0 as p,$ as m,aV as h,Y as f,B as x,T as y,bG as v}from"./chunk-BxJbIkJM.js";import{r as j}from"./chunk-nBmrMGrr.js";import{a as M}from"./chunk-Csfs_AE2.js";import{S as k}from"./chunk-Bs-FQgGV.js";import"./chunk-BsETiAjl.js";const w=()=>{var w,C,b,B;const[$,T]=j.useState(!1),[S,U]=j.useState(null),[z,N]=j.useState([]),[P,O]=j.useState(null),[H,I]=j.useState(!1);j.useEffect(()=>{D()},[]);const D=()=>n(null,null,function*(){T(!0);try{const n=yield M.get("/api/master/migrations/pending");N(n.data.data||[])}catch(n){i.error("Migration durumu alınamadı")}finally{T(!1)}}),K=[{title:"Tenant",key:"tenant",render:n=>e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:500},children:n.tenantName}),e.jsx("div",{style:{fontSize:12,color:"#666"},children:n.tenantCode})]})},{title:"Durum",key:"status",render:n=>n.error?e.jsx(f,{color:"error",children:"Hata"}):n.hasPendingMigrations?e.jsx(x,{count:n.pendingMigrations.length,children:e.jsx(f,{color:"warning",children:"Bekleyen Migration Var"})}):e.jsx(f,{color:"success",children:"Güncel"})},{title:"Bekleyen Migrationlar",key:"pending",render:n=>n.error?e.jsx(y,{title:n.error,children:e.jsx("span",{style:{color:"#ff4d4f"},children:"Bağlantı hatası"})}):n.hasPendingMigrations?e.jsx("div",{children:n.pendingMigrations.map((n,i)=>e.jsxs("div",{style:{fontSize:12},children:["• ",n]},i))}):e.jsx("span",{style:{color:"#52c41a"},children:"Yok"})},{title:"Uygulanan",key:"applied",render:n=>{var i;return e.jsxs("span",{children:[(null==(i=n.appliedMigrations)?void 0:i.length)||0," migration"]})}},{title:"İşlemler",key:"actions",width:200,render:i=>e.jsxs(o,{children:[e.jsx(y,{title:"Migration geçmişini görüntüle",children:e.jsx(d,{type:"link",icon:e.jsx(v,{}),onClick:()=>{return e=i,n(null,null,function*(){O(e),I(!0)});var e}})}),i.hasPendingMigrations&&!i.error&&e.jsx(d,{type:"primary",size:"small",icon:e.jsx(g,{}),loading:S===i.tenantId,onClick:()=>{return e=i.tenantId,a=i.tenantName,n(null,null,function*(){const i=yield k.fire({title:"Migration Uygula",html:`\n        <div>\n          <p><strong>${a}</strong> tenant'ına migration'lar uygulanacak.</p>\n          <div style="background-color: #fff2e8; border: 1px solid #faad14; border-radius: 4px; padding: 12px; margin-top: 12px;">\n            <strong style="color: #faad14;">⚠️ Dikkat</strong><br/>\n            Bu işlem database şemasını değiştirecektir. İşlem geri alınamaz!\n          </div>\n        </div>\n      `,icon:"warning",showCancelButton:!0,confirmButtonText:"Uygula",cancelButtonText:"İptal",confirmButtonColor:"#ff4d4f",showLoaderOnConfirm:!0,preConfirm:()=>n(null,null,function*(){var n,i;try{return(yield M.post(`/api/master/migrations/apply/${e}`)).data}catch(a){throw k.showValidationMessage(`Hata: ${(null==(i=null==(n=a.response)?void 0:n.data)?void 0:i.message)||a.message||"Migration uygulanamadı"}`),a}}),allowOutsideClick:()=>!k.isLoading()});i.isConfirmed&&(U(e),yield k.fire({title:"Başarılı!",html:`\n          <div>\n            <p>${i.value.message||"Migration başarıyla uygulandı"}</p>\n            ${i.value.appliedMigrations&&i.value.appliedMigrations.length>0?`\n              <div style="margin-top: 12px; text-align: left;">\n                <strong>Uygulanan Migration'lar:</strong>\n                <ul style="margin-top: 8px;">\n                  ${i.value.appliedMigrations.map(n=>`<li>${n}</li>`).join("")}\n                </ul>\n              </div>\n            `:""}\n          </div>\n        `,icon:"success",confirmButtonColor:"#52c41a"}),yield D(),U(null))});var e,a},children:"Migration Uygula"})]})}],L=z.filter(n=>n.hasPendingMigrations&&!n.error);return e.jsxs("div",{className:"migrations-page",children:[e.jsxs(a,{title:e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs("span",{children:[e.jsx(s,{})," Database Migration Yönetimi"]}),e.jsxs(o,{children:[e.jsx(d,{icon:e.jsx(g,{}),onClick:D,loading:$,children:"Yenile"}),L.length>0&&e.jsxs(d,{type:"primary",danger:!0,icon:e.jsx(c,{}),onClick:()=>n(null,null,function*(){const i=yield k.fire({title:"Tüm Tenantlara Migration Uygula",html:'\n        <div>\n          <p>Tüm aktif tenant\'lara bekleyen migration\'lar uygulanacak.</p>\n          <div style="background-color: #fff1f0; border: 1px solid #ff4d4f; border-radius: 4px; padding: 12px; margin-top: 12px;">\n            <strong style="color: #ff4d4f;">🚨 Kritik İşlem</strong><br/>\n            Bu işlem TÜM tenant database\'lerini güncelleyecektir. İşlem geri alınamaz ve uzun sürebilir!\n          </div>\n        </div>\n      ',icon:"error",showCancelButton:!0,confirmButtonText:"Tümüne Uygula",cancelButtonText:"İptal",confirmButtonColor:"#ff4d4f",showLoaderOnConfirm:!0,preConfirm:()=>n(null,null,function*(){var n,i;try{return(yield M.post("/api/master/migrations/apply-all")).data}catch(e){throw k.showValidationMessage(`Hata: ${(null==(i=null==(n=e.response)?void 0:n.data)?void 0:i.message)||e.message||"Migrationlar uygulanamadı"}`),e}}),allowOutsideClick:()=>!k.isLoading()});if(i.isConfirmed){T(!0);let n=`<p>${i.value.message}</p><hr/>`;n+='<div style="max-height: 400px; overflow: auto; text-align: left;">',i.value.results.forEach(i=>{const e=i.success?"✅":"❌",a=i.success?"#52c41a":"#ff4d4f";n+=`\n          <div style="margin-bottom: 12px; padding: 8px; border-left: 3px solid ${a};">\n            <span>${e}</span>\n            <strong>${i.tenantName}:</strong> ${i.message}\n            ${i.error?`<div style="color: #ff4d4f; margin-top: 4px; font-size: 12px;">${i.error}</div>`:""}\n            ${i.appliedMigrations&&i.appliedMigrations.length>0?`\n              <div style="margin-top: 4px; font-size: 12px;">\n                <em>Uygulanan: ${i.appliedMigrations.join(", ")}</em>\n              </div>\n            `:""}\n          </div>\n        `}),n+="</div>",yield k.fire({title:"Migration Sonuçları",html:n,icon:i.value.failureCount>0?"warning":"success",confirmButtonText:"Tamam",confirmButtonColor:i.value.failureCount>0?"#faad14":"#52c41a",width:800}),yield D(),T(!1)}}),loading:$,children:["Tümüne Uygula (",L.length," tenant)"]})]})]}),children:[L.length>0&&e.jsx(t,{message:`${L.length} tenant'ta bekleyen migration var`,description:"Migration'ları tek tek veya toplu olarak uygulayabilirsiniz.",type:"warning",showIcon:!0,style:{marginBottom:16}}),e.jsx(r,{spinning:$,children:e.jsx(l,{dataSource:z,columns:K,rowKey:"tenantId",pagination:!1,rowClassName:n=>n.error?"error-row":""})})]}),e.jsx(u,{title:`Migration Geçmişi - ${null==P?void 0:P.tenantName}`,open:H,onCancel:()=>I(!1),footer:[e.jsx(d,{onClick:()=>I(!1),children:"Kapat"},"close")],width:600,children:P&&e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Tenant Kodu:"})," ",P.tenantCode]}),e.jsx(p,{}),e.jsxs("h4",{children:["Uygulanan Migration'lar (",(null==(w=P.appliedMigrations)?void 0:w.length)||0,")"]}),e.jsx("div",{style:{maxHeight:300,overflow:"auto"},children:(null==(C=P.appliedMigrations)?void 0:C.map((n,i)=>e.jsxs("div",{style:{padding:"4px 0"},children:[e.jsx(m,{style:{color:"#52c41a",marginRight:8}}),n]},i)))||e.jsx("p",{children:"Migration geçmişi yok"})}),P.hasPendingMigrations&&e.jsxs(e.Fragment,{children:[e.jsx(p,{}),e.jsxs("h4",{style:{color:"#faad14"},children:["Bekleyen Migration'lar (",(null==(b=P.pendingMigrations)?void 0:b.length)||0,")"]}),e.jsx("div",{style:{maxHeight:200,overflow:"auto"},children:null==(B=P.pendingMigrations)?void 0:B.map((n,i)=>e.jsxs("div",{style:{padding:"4px 0"},children:[e.jsx(h,{style:{color:"#faad14",marginRight:8}}),n]},i))})]})]})})]})};export{w as default};
